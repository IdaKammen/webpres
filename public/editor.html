<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <link rel="stylesheet" type="text/css" href="css/edit.css" />
    <title>Editmode</title>
</head>

<body>
    <p class="logo">List it</p>

    <div class="list">
        <button class="menyBtn" id="backBtn">Back</button>
        <br>
        <div id="title" class="listTitle"></div>
        <br>
        <input class="input" type="text" id="inpItem" placeholder="item">
        <button id="addBtn" class="underMeny">add to list</button>
        <br><br>
        <div id="container"></div>
    </div>
</body>

<script>

    let url = "http://localhost:3000/editor";

    let inpTitle = document.getElementById("titleInp");
    let inpItem = document.getElementById("inpItem");
    let saveBtn = document.getElementById("saveBtn");
    let titleBtn = document.getElementById("titleBtn");
    let backBtn = document.getElementById("backBtn");
    let title = document.getElementById("title");

    let listID = sessionStorage.getItem('listId');
    let listTitle = sessionStorage.getItem('listTitle');

    // setter title fra storage til list title. 
    title.innerText = listTitle;

    backBtn.addEventListener('click', function (evt) {
        window.location.href = "user.html";
    });


    let addBtn = document.getElementById("addBtn");
    let container = document.getElementById("container");

    console.log("dette er list ID " + listID);
    console.log("dette er list title: " + listTitle);

    loadList();

    async function loadList() {

        try {

            var auth = JSON.parse(sessionStorage.getItem("auth"));
            let token = auth.token;

            let cfg = {
                method: "GET",
                headers: { "authorization": token }
            };

            var resp = await fetch(url + "?listid=" + listID, cfg);
            var data = await resp.json();

            if (resp.status > 202) {
                throw (data);
            };

            container.innerHTML = "";

            console.log(data);

            for (let value of data) {

                let listDiv = document.createElement("div");
                listDiv.classList.add("listDiv");

                let checkBox = document.createElement("input");
                checkBox.type = "checkbox";
                checkBox.classList.add("checkBox");

                let listItem = document.createElement("span");
                listItem.classList.add("listItem");
                listItem.innerHTML = value.item;

                let deleteBtn = document.createElement("button");
                deleteBtn.textContent = "Delete";
                deleteBtn.classList.add("listBtn");
                deleteBtn.addEventListener('click', function (evt) {
                    deleteItem(value.id);
                    console.log("inni eventlistener i deleteBtn " + value.id);
                });

                let editBtn = document.createElement("button");
                editBtn.textContent = "Edit";
                editBtn.classList.add("listBtn");
                editBtn.addEventListener('click', function (evt) {
                    //editItem() m책 kunne endre p책 et item i arrayet
                });

                listDiv.appendChild(checkBox);
                listDiv.appendChild(listItem);
                listDiv.appendChild(deleteBtn);
                listDiv.appendChild(editBtn);

                container.appendChild(listDiv);
            }
        }
        catch (err) {
            console.log(err);
        }
    };


    // Hver gang en list item legges til/lages s책 legges den opp i tabellen p책 DB.! Da trenger man ikke Save btn?

    addBtn.addEventListener('click', async function (evt) {

        let url = "http://localhost:3000/editor";

        let auth = JSON.parse(sessionStorage.getItem("auth"));
        let token = auth.token;

        let listItem = inpItem.value;

        let updata = {
            item: listItem,
            listid: listID,
            userid: auth.userid
        }

        let cfg = {
            method: "POST",
            headers: {
                "authorization": token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(updata)
        }

        try {
            var resp = await fetch(url, cfg);
            var data = await resp.json();

            if (resp.status > 202) {
                throw (data);
            };
        }
        catch (err) {
            console.log(err);
        }
        loadList();
    });

    async function deleteItem(id) {

        let updata = { itemID: id };

        let auth = JSON.parse(sessionStorage.getItem("auth"));
        let token = auth.token;

        console.log("updata inne i delete Item " + updata);

        let cfg = {
            method: "DELETE",
            headers: {
                "authorization": token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(updata)
        }

        try {
            let resp = await fetch(url, cfg);

            if (resp.status > 202) {
                throw (data);
            };

            loadList();
        }
        catch (err) {
            console.log(err);
        }
    }


</script>

</html>