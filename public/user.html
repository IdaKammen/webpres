<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <link rel="stylesheet" type="text/css" href="css/user.css" />
    <title>Userprofile</title>
</head>

<body>
    <header class="header">
        <p class="logo">List it</p>

    </header>
    <main>
        <div class="list">
            <button class="menyBtn" id="editProfileBtn">Edit Profile</button>
            <button class="menyBtn" id="logoutBtn">Log out</button>
            <br><br>
            <input class="input" type="text" id="titleInput" placeholder="New list title">
            <button class="menyBtn" id="createBtn">Create new list</button>
            <br>
            <span class="title" id="title">My lists </span>
            <div class="username" id="username"></div>
            <br><br>
            <span>&#10003;</span>
            <div id="container"></div>
        </div>
    </main>
    <div id="myModal" class="modal">
    
        
        <div class="modal-content">
          
          <div class="form" id = "myForm2">
                <span class="close">&times;</span>
                      <h2 style="text-align:center;">Update User</h2>
                      <p style>Username</p>
                      <input type="text" id="inpUsername" placeholder = "New Username">
                      <p>Password</p>
                      <input  type="password" id="inpPwrd" placeholder = "New Password"> 
                      <p>E-mail</p> 
                      <input type="email" id="inpEmail" placeholder= "New E-mail">
          </br>
          </br>
                      <button class="createUser2" id="updateUserBtn">Update User </button>
                      
                      
                  </div>
        </div>
      
      </div>
</body>

<script>

    let createBtn = document.getElementById("createBtn");
    let titleInp = document.getElementById("titleInput");

    let editProfileBtn = document.getElementById("editProfileBtn");
    editProfileBtn.addEventListener('click', function (evt) {
        window.location.href = "profileinfo.html";
        // m책 f책 opp modal, TOM jobber med det
    });

    let logoutBtn = document.getElementById("logoutBtn");
    logoutBtn.addEventListener('click', function (evt) {
        sessionStorage.clear();
        window.location.href = "index.html";
    });

    let container = document.getElementById("container");

    let url = "http://localhost:3000/user";

    let userData = JSON.parse(sessionStorage.getItem("auth"));
    let username = document.getElementById("username");
    username.innerHTML = "Logged in as: " + userData.username;

    createBtn.addEventListener('click', async function (evt) {

        if (titleInp.value) {

            titleInp.classList = "input";

            let url = "http://localhost:3000/user";

            let auth = JSON.parse(sessionStorage.getItem('auth'));
            let token = auth.token;

            let updata = {
                title: titleInp.value,
                public: false,
                userid: auth.userid
            }

            let cfg = {
                method: "POST",
                headers: {
                    "authorization": token,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(updata)
            }

            try {
                var resp = await fetch(url, cfg);
                var data = await resp.json();
                titleInp.value = "";

                if (resp.status > 202) {
                    throw (data);
                };

                loadList();
            }
            catch (err) {
                console.log(err);
            }
        } else {

            titleInp.classList.add("noInp");

        }
    });

    loadList();

    async function loadList() {

        try {

            let auth = JSON.parse(sessionStorage.getItem('auth'));
            let token = auth.token;

            let cfg = {
                method: "GET",
                headers: { "authorization": token }
            };

            var resp = await fetch(url, cfg);
            var data = await resp.json();

            if (resp.status > 202) {
                throw (data);
            }

            container.innerHTML = "";

            for (let value of data) {
                let listDiv = document.createElement("div");
                listDiv.classList.add("listDiv");

                let listTitle = document.createElement("span");
                listTitle.classList.add("listItem");

                let html = `<li>${value.title}</li>`;
                listTitle.innerHTML = html;
                listTitle.addEventListener('click', function (evt) {
                    sessionStorage.setItem("listId", value.id);
                    sessionStorage.setItem("listTitle", value.title);
                    window.location.href = "editor.html";
                });

                let delBtn = document.createElement("button");
                delBtn.innerHTML = "Delete";
                delBtn.classList.add("listBtn");
                delBtn.addEventListener('click', function (evt) {
                    deleteList(value.id);
                });

                let checkBox = document.createElement("input");
                checkBox.type = "checkbox";
                checkBox.classList.add("checkBox");

                if (value.public === "true") {
                    checkBox.checked = true;
                } else {
                    checkBox.checked = false;
                };

                checkBox.addEventListener('change', function (evt) {
                    publicTagging(value.public, value.id);
                });

                let public = document.createElement("p");
                public.innerText = "Public: "

                let br = document.createElement("br");

                listDiv.appendChild(listTitle);
                listDiv.appendChild(delBtn);
                listDiv.appendChild(public);
                listDiv.appendChild(checkBox);

                container.appendChild(listDiv);
                container.appendChild(br);

            }

        }
        catch (err) {
            console.log(err);
        }
    };

    // ---------------------------------------    
    async function deleteList(id) {

        let updata = { listID: id };

        let auth = JSON.parse(sessionStorage.getItem('auth')); // henter token fra sessionStorage for 책 sende det med
        let token = auth.token;

        let cfg = {
            method: "DELETE",
            headers: {
                "authorization": token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(updata)
        }

        try {
            let resp = await fetch(url, cfg);
            if (resp.status > 202) {   // hvis responsen har en statuskode som er over 202 er ikke token godkjent og clienten .
                throw (data);
            };

            loadList();
        }
        catch (err) {
            console.log(err);
        }
    }

    async function publicTagging(state, id) {

        if (state == "false") {
            state = "true";
        } else if (state == "true") {
            state = "false";
        };

        let updata = {
            public: state,
            listid: id
        };

        let auth = JSON.parse(sessionStorage.getItem('auth')); // henter token fra sessionStorage for 책 sende det med
        let token = auth.token;

        let cfg = {
            method: "PUT",
            headers: {
                "authorization": token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(updata)
        }

        try {
            let resp = await fetch(url, cfg);
            var data = await resp.json();

            console.log("resp data sendt tilbake" + data);
            if (resp.status > 202) {   // hvis responsen har en statuskode som er over 202 er ikke token godkjent og clienten .
                throw (data);
            };

            loadList();
        }
        catch (err) {
            console.log(err);
        }
    }

</script>

</html>