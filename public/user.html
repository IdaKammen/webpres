<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <link rel="stylesheet" type="text/css" href="css/user.css" />
    <title>Userprofile</title>
</head>

<body>
    <header class="header">
        <p class="logo">List it</p>

    </header>
    <main>
        <div class="list">
            <button class="menyBtn" id="editProfileBtn">Edit Profile</button>
            <button class="menyBtn" id="logoutBtn">Log out</button>
            <br><br>
            <input class="input" type="text" id="titleInput" placeholder="New list title">
            <button class="menyBtn" id="createBtn">Create new list</button>
            <br>
            <span class="title" id="title">My lists </span>
            <div class="username" id="username"></div>
            <br><br>
            <div id="container"></div>
        </div>
    </main>

    <div id="myModal" class="modal">

        <div class="modal-content">

            <div class="innerForm" id="myForm2">
                <span class="close">&times;</span>
                <h1 class="heading profileheding">Profile information</h1>
                <p id="username2">Username</p>
                <input type="text" id="inpUsername" placeholder=" New username">
                <p id="email">E-mail address</p>
                <input type="email" id="inpEmail" placeholder="New email">
                <p id="psw">Create new password</p>
                <input type="password" id="inpNew" placeholder=" New password">
                <br>
                <br>
                <button class="updateBTN" id="updateBtn">Update info</button>
                <button class="deletuser" id="deleteUser">Delete useraccount</button>

            </div>
        </div>
</body>

<script>

    let inpUsername = document.getElementById('inpUsername');
    let inpEmail = document.getElementById('inpEmail');
    let inpNewPassword = document.getElementById('inpNew');

    let username2 = document.getElementById('username2');
    let psw = document.getElementById('psw');
    let email = document.getElementById('email');
    let updateBtn = document.getElementById('updateBtn');

    let deletUSER = document.getElementById("deleteUser");

    let modal = document.getElementById("myModal");
    modal.style.display = "none";
    let modalBtn = document.getElementById("editProfileBtn");

    let span = document.getElementsByClassName("close")[0];

    modalBtn.onclick = function () {
        modal.style.display = "block";
        loadUser();
    };

    span.onclick = function () {
        modal.style.display = "none";
    };

    let createBtn = document.getElementById("createBtn");
    let titleInp = document.getElementById("titleInput");


    let logoutBtn = document.getElementById("logoutBtn");
    logoutBtn.addEventListener('click', function (evt) {
        sessionStorage.clear();
        window.location.href = "index.html";
    });

    let container = document.getElementById("container");

    let url;
    if (window.location.hostname == "localhost") {
        url = "https://localhost:3000" + "/lists";
    } else {
        url = window.location.hostname + "/lists";
    };

    let userData = JSON.parse(sessionStorage.getItem("auth"));
    let username = document.getElementById("username");
    username.innerHTML = "Logged in as: " + userData.username;

    createBtn.addEventListener('click', async function (evt) {

        if (titleInp.value) {

            titleInp.classList = "input";

            let url;
            if (window.location.hostname == "localhost") {
                url = "https://localhost:3000" + "/lists";
            } else {
                url = window.location.hostname + "/lists";
            };

            let auth = JSON.parse(sessionStorage.getItem('auth'));
            let token = auth.token;

            let updata = {
                title: titleInp.value,
                public: false,
                userid: auth.userid
            }

            let cfg = {
                method: "POST",
                headers: {
                    "authorization": token,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(updata)
            }

            try {
                var resp = await fetch(url, cfg);
                var data = await resp.json();
                titleInp.value = "";

                if (resp.status > 202) {
                    throw (data);
                };

                loadList();
            }
            catch (err) {
            }
        } else {

            titleInp.classList.add("noInp");

        }
    });

    loadList();

    async function loadList() {

        try {

            let auth = JSON.parse(sessionStorage.getItem('auth'));
            let token = auth.token;

            let cfg = {
                method: "GET",
                headers: { "authorization": token }
            };

            var resp = await fetch(url, cfg);
            var data = await resp.json();

            if (resp.status > 202) {
                throw (data);
            }

            container.innerHTML = "";

            for (let value of data) {
                let listDiv = document.createElement("div");
                listDiv.classList.add("listDiv");

                let listTitle = document.createElement("span");
                listTitle.classList.add("listItem");

                let html = `<li>${value.title}</li>`;
                listTitle.innerHTML = html;
                listTitle.addEventListener('click', function (evt) {
                    sessionStorage.setItem("listId", value.id);
                    sessionStorage.setItem("listTitle", value.title);
                    window.location.href = "editor.html";
                });

                let delBtn = document.createElement("button");
                delBtn.innerHTML = "Delete";
                delBtn.classList.add("listBtn");
                delBtn.addEventListener('click', function (evt) {
                    deleteList(value.id);
                });

                let checkBox = document.createElement("input");
                checkBox.type = "checkbox";
                checkBox.classList.add("checkBox");

                if (value.public === "true") {
                    checkBox.checked = true;
                } else {
                    checkBox.checked = false;
                };

                checkBox.addEventListener('change', function (evt) {
                    publicTagging(value.public, value.id);
                });

                let public = document.createElement("p");
                public.innerText = "Public: "

                let br = document.createElement("br");

                listDiv.appendChild(listTitle);
                listDiv.appendChild(delBtn);
                listDiv.appendChild(public);
                listDiv.appendChild(checkBox);

                container.appendChild(listDiv);
                container.appendChild(br);

            }

        }
        catch (err) {
            console.log(err);
        }
    };

    async function deleteList(id) {

        let updata = { listID: id };

        let auth = JSON.parse(sessionStorage.getItem('auth'));
        let token = auth.token;

        let cfg = {
            method: "DELETE",
            headers: {
                "authorization": token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(updata)
        }

        try {
            let resp = await fetch(url, cfg);
            if (resp.status > 202) {
                throw (data);
            };

            loadList();
        }
        catch (err) {
            console.log(err);
        }
    }

    async function publicTagging(state, id) {

        if (state == "false") {
            state = "true";
        } else if (state == "true") {
            state = "false";
        };

        let updata = {
            public: state,
            listid: id
        };

        let auth = JSON.parse(sessionStorage.getItem('auth'));
        let token = auth.token;

        let cfg = {
            method: "PUT",
            headers: {
                "authorization": token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(updata)
        }

        try {
            let resp = await fetch(url, cfg);
            var data = await resp.json();

            if (resp.status > 202) {
                throw (data);
            };

            loadList();
        }
        catch (err) {
            console.log(err);
        }
    }

    // ---- edit user profile code -------------------

    async function loadUser() {

        let url;
        if (window.location.hostname == "localhost") {
            url = "https://localhost:3000" + "/profile";
        } else {
            url = window.location.hostname + "/profile";
        };

        try {
            let auth = JSON.parse(sessionStorage.getItem('auth'));
            let token = auth.token;

            let cfg = {
                method: "GET",
                headers: { "authorization": token }
            };

            var resp = await fetch(url, cfg);
            var data = await resp.json();

            if (resp.status > 202) {
                throw (data);
            };

            username2.innerText = "Username: " + data[0].username;
            email.innerText = "Email: " + data[0].email;
        }

        catch (err) {
            console.log(err);
        }
    };

    updateBtn.addEventListener('click', async function (evt) {

        // HER MÃ… DET SJEKKES OM ALLE FELTENE ER FYLLT INN, HVIS IKKE SKRIV UT ERRORMELDING OG IKKE SEND DATA

        let url;
        if (window.location.hostname == "localhost") {
            url = "https://localhost:3000" + "/profile";
        } else {
            url = window.location.hostname + "/profile";
        };

        let auth = JSON.parse(sessionStorage.getItem('auth'));
        let token = auth.token;

        let updata = {
            username: inpUsername.value,
            password: inpNewPassword.value,
            email: inpEmail.value
        }

        let cfg = {
            method: "PUT",
            headers: {
                "authorization": token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(updata)
        }

        try {
            var resp = await fetch(url, cfg);
            var data = await resp.json();

            if (resp.status > 202) {
                throw (data);
            };

            loadUser();

        }
        catch (err) {
            console.log(err);
        }

    });

    deletUSER.addEventListener('click', async function (evt) {

        if (confirm('Are you sure you want to delete user?')) {

            let url;
            if (window.location.hostname == "localhost") {
                url = "https://localhost:3000" + "/profile";
            } else {
                url = window.location.hostname + "/profile";
            };

            let auth = JSON.parse(sessionStorage.getItem('auth'));
            let token = auth.token;
            let updata = { userid: auth.userid };

            let cfg = {
                method: "DELETE",
                headers: {
                    "authorization": token,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(updata)
            }

            try {
                let resp = await fetch(url, cfg);
                if (resp.status > 202) {
                    throw (data);
                };

                sessionStorage.clear();
                window.location.href = "index.html";
            }
            catch (err) {
                console.log(err);
            }
        }
    });

</script>

</html>