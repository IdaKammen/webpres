<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <link rel="stylesheet" type="text/css" href="css/edit.css" />
    <title>userprofile</title>
</head>

<body>
    <header class="header">
        <p class="logo">List it</p>
    </header>
    <main>
        <section>
            <div class="hoveddiv">
                <h1 class="heading edittask" id="heading">Edit task</h1>
                <p id="item"></p>
                <input type="text" id="inpItem" class="inputItem" placeholder="New task">
                <p id="desc"></p>
                <input type="text" id="inpDesc" class="inputDesc" placeholder="New description">
                <p id="date"></p>
                <input type="date" id="inpDate" class="inputDate">
                <br>
                <br>
                <button class="updateBtn" id="updateBtn">Update task</button>
                <button id="backBtn"> Back </button>
            </div>
        </section>
    </main>
</body>

<script>

    let inpItem = document.getElementById('inpItem');
    let inpDesc = document.getElementById('inpDesc');
    let inpDate = document.getElementById('inpDate');

    let item = document.getElementById('item');
    let desc = document.getElementById('desc');
    let newDate = document.getElementById('date');
    let backBtn = document.getElementById('backBtn');
    let updateBtn = document.getElementById('updateBtn');

    backBtn.addEventListener('click', function (evt) {
        window.location.href = "editor.html";
    });

    let url = "http://localhost:3000/edititem";

    let itemID = sessionStorage.getItem('itemid');

    loadData();

    async function loadData() {

        try {
            let auth = JSON.parse(sessionStorage.getItem('auth'));
            let token = auth.token;

            let cfg = {
                method: "GET",
                headers: { "authorization": token }
            };

            var resp = await fetch(url + "?itemid=" + itemID, cfg);
            var data = await resp.json();

            console.log("data fÃ¥tt tilbake fra server " + JSON.stringify(data));

            if (resp.status > 202) {
                throw (data);
            };

            let task = data[0].item;
            let descr = data[0].description;
            let longDate = data[0].date;
            let shortDate = data[0].date.toString().split('T')[0];
            
            item.innerText = "Task: " + task;
            desc.innerText = "Description: " + descr;
            newDate.innerText = "Due date: " + shortDate;

            updateBtn.addEventListener('click', async function (evt) {
                editItem(task, descr, longDate);
            });

        }

        catch (err) {
            console.log(err);
        }
    };

    async function editItem(item, desc, date) {

        let url = "http://localhost:3000/edititem";

        let auth = JSON.parse(sessionStorage.getItem('auth'));
        let token = auth.token;

        let newTask;
        let newDesc;
        let newDate;

        if (inpItem.value) {
            newTask = inpItem.value;
        } else {
            newTask = item;
        };

        if (inpDesc.value) {
            newDesc = inpDesc.value;
        } else {
            newDesc = desc;
        };

        if (inpDate.value) {
            dueDate = inpDate.value;
        } else {
            dueDate = date;
        };

        let updata = {
            item: newTask,
            description: newDesc,
            duedate: dueDate,
            listid: itemID,
            userid: auth.userid
        }

        let cfg = {
            method: "PUT",
            headers: {
                "authorization": token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(updata)
        }

        try {
            var resp = await fetch(url, cfg);
            var data = await resp.json();

            if (resp.status > 202) {
                throw (data);
            };

            loadData();
        }
        catch (err) {
            console.log(err);
        }
    };

</script>

</html>